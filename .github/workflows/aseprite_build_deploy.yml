name: Build and deploy Aseprite

on:
  push: 
    branches:
      - master
  workflow_dispatch:

env:
  BUILD_TYPE: RelWithDebInfo

jobs:
  build-aseprite:
    name: Build Aseprite (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout Aseprite repository
        uses: actions/checkout@v4
        with:
          repository: aseprite/aseprite
          ref: main
          submodules: recursive

      - name: Install Ninja
        shell: cmd
        run: choco install ninja -y

      - name: Download prebuilt Skia (m124)
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\deps\skia"
          Invoke-WebRequest -Uri "https://github.com/aseprite/skia/releases/download/m124-08a5439a6b/Skia-Windows-Release-x64.zip" -OutFile "$env:GITHUB_WORKSPACE\skia.zip"
          Expand-Archive -Path "$env:GITHUB_WORKSPACE\skia.zip" -DestinationPath "$env:GITHUB_WORKSPACE\deps\skia" -Force
          Write-Host "Skia extracted to: $env:GITHUB_WORKSPACE\deps\skia"
          Get-ChildItem -Path "$env:GITHUB_WORKSPACE\deps\skia" -Recurse | Select-Object -First 20
          if (Test-Path "$env:GITHUB_WORKSPACE\deps\skia\out\Release-x64\skia.lib") {
            Write-Host "Skia library found!"
          } else {
            Write-Host "Skia library NOT found!"
            exit 1
          }

      - name: Configure CMake
        shell: cmd
        run: |
          mkdir build
          cd build
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=x64
          cmake -DCMAKE_BUILD_TYPE=%BUILD_TYPE% ^
                -DLAF_BACKEND=skia ^
                -DSKIA_DIR=%GITHUB_WORKSPACE%\deps\skia ^
                -DSKIA_LIBRARY_DIR=%GITHUB_WORKSPACE%\deps\skia\out\Release-x64 ^
                -DSKIA_LIBRARY=%GITHUB_WORKSPACE%\deps\skia\out\Release-x64\skia.lib ^
                -G Ninja ..

      - name: Build Aseprite
        shell: cmd
        working-directory: build
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=x64
          ninja aseprite

      - name: Cleanup build artifacts
        shell: bash
        working-directory: build/bin
        run: rm -f gen modp_b64_gen *.ilk *.pdb *.manifest *.exe.manifest

      - name: Copy OpenSSL DLLs
        shell: powershell
        run: |
          # OpenSSL is pre-installed on windows-latest runners
          $opensslPath = "C:\Program Files\OpenSSL\bin"
          if (Test-Path $opensslPath) {
            Copy-Item "$opensslPath\libcrypto-3-x64.dll" -Destination "build\bin\" -Force
            Copy-Item "$opensslPath\libssl-3-x64.dll" -Destination "build\bin\" -Force
            Write-Host "OpenSSL DLLs copied successfully!"
          } else {
            # Fallback: Install OpenSSL via chocolatey
            choco install openssl -y
            $chocoOpenssl = "C:\Program Files\OpenSSL-Win64\bin"
            Copy-Item "$chocoOpenssl\libcrypto-3-x64.dll" -Destination "build\bin\" -Force
            Copy-Item "$chocoOpenssl\libssl-3-x64.dll" -Destination "build\bin\" -Force
            Write-Host "OpenSSL DLLs copied from choco install!"
          }
          Get-ChildItem "build\bin\*.dll"

      - name: Make portable
        shell: cmd
        working-directory: build\bin
        run: echo # portable > aseprite.ini

      - name: Create zip
        shell: cmd
        working-directory: build\bin
        run: 7z a Aseprite-Windows.zip *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Aseprite-Windows
          path: build\bin\Aseprite-Windows.zip
